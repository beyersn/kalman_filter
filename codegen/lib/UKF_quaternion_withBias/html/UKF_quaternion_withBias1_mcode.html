<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T14U3">Attitude_sensor</span>, <span class="var type1" id="S3T1U4">w_sensor</span>, <span class="var type1" id="S4T1U5">w_bias_sensor</span>]  = UKF_quaternion_withBias(<span class="var type1" id="S5T1U8">B_ref</span>, <span class="var type1" id="S6T1U9">B_sat</span>, <span class="var type1" id="S7T1U10">w_gyro</span>, <span class="var type1" id="S8T1U11">Torque_s</span>, <span class="var type1" id="S9T2U12">Ts</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">  2</a></span><span class="line"><span class="comment">%#codegen</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">  3</a></span><span class="line"><span class="comment">% UKF_quaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">  4</a></span><span class="line"><span class="comment">% Author: Brandon Jackson</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">  5</a></span><span class="line"><span class="comment">% Contact: bajackso@mtu.edu</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">  6</a></span><span class="line"><span class="comment">% Date: 22 May 2013</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">  7</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">  8</a></span><span class="line"><span class="comment">% This function performs an Unscented Kalman Filter to determine the</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">  9</a></span><span class="line"><span class="comment">% spacecraft attitude.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10"> 10</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11"> 11</a></span><span class="line"><span class="comment">% The state vector is: [Error Quaternion (3,1); Angular_Velocity; Gyro Bias (3,1)]</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12"> 12</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13"> 13</a></span><span class="line"><span class="comment">% Vectors will be normalized, direction not magnitude, is what is important</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14"> 14</a></span><span class="line"><span class="comment">% values closer to one will have less issues with roundoff.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15"> 15</a></span><span class="line"><span class="mxinfo" id="T1:U9"><span class="var type1" id="S6T1U15">B_sat</span> = <span class="mxinfo" id="T1:U11"><span class="var type1" id="S6T1U17">B_sat</span>./<span class="mxinfo" id="T2:U13">sqrt(<span class="mxinfo" id="T2:U14">sum(<span class="mxinfo" id="T1:U15"><span class="var type1" id="S6T1U23">B_sat</span>.^2</span>)</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16"> 16</a></span><span class="line"><span class="mxinfo" id="T1:U17"><span class="var type1" id="S5T1U27">B_ref</span> = <span class="mxinfo" id="T1:U19"><span class="var type1" id="S5T1U29">B_ref</span>./<span class="mxinfo" id="T2:U21">sqrt(<span class="mxinfo" id="T2:U22">sum(<span class="mxinfo" id="T1:U23"><span class="var type1" id="S5T1U35">B_ref</span>.^2</span>)</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17"> 17</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18"> 18</a></span><span class="line"><span class="comment">% Declare persistent variables. These variables behave similiar to global</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19"> 19</a></span><span class="line"><span class="comment">% variables although they are only present within this function</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20"> 20</a></span><span class="line"><span class="keyword">persistent</span> <span class="var type1" id="S12T13U38">P_km1km1</span> <span class="var type1" id="S13T17U39">x_km1km1</span> <span class="var type1" id="S14T17U40">x_kk</span> <span class="var type1" id="S15T19U41">R_k</span> <span class="var type1" id="S16T13U42">Q_k</span> <span class="var type1" id="S17T2U43">Lambda</span> <span class="var type1" id="S18T2U44">alpha</span> <span class="var type1" id="S19T2U45">K</span> <span class="var type1" id="S20T2U46">Beta</span> <span class="var type1" id="S21T14U47">q_s_c</span> <span class="var type1" id="S22T16U48">I_c</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21"> 21</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22"> 22</a></span><span class="line"><span class="comment">%% Initialize filter if necessary</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23"> 23</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo" id="T5:U36"><span class="mxinfo" id="T5:U37">isempty(<span class="var type2" id="S13T0U53">x_km1km1</span>)</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24"> 24</a></span><span class="line">    <span class="mxinfo" id="T14:U38"><span class="var type1" id="S21T14U56">q_s_c</span> = <span class="mxinfo" id="T14:U40">[<span class="mxinfo" id="T2:U41">1</span>; <span class="mxinfo" id="T2:U42">0</span>; <span class="mxinfo" id="T2:U43">0</span>; <span class="mxinfo" id="T2:U44">0</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25"> 25</a></span><span class="line">    <span class="mxinfo" id="T16:U45"><span class="var type1" id="S22T16U68">I_c</span> = <span class="mxinfo" id="T16:U47">[<span class="mxinfo" id="T2:U48">3.4</span> <span class="mxinfo" id="T2:U49">3.4</span> <span class="mxinfo" id="T2:U50">1.9</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26"> 26</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27"> 27</a></span><span class="line">    <span class="comment">% Initialize the initial error covariance matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28"> 28</a></span><span class="line">    <span class="mxinfo" id="T13:U51"><span class="var type1" id="S12T13U76">P_km1km1</span> = <span class="mxinfo" id="T13:U53"><span class="mxinfo" id="T13:U54">diag([1 1 1 0.1 0.1 0.1 1 1 1])</span>*<span class="mxinfo" id="T2:U55">1E-3</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29"> 29</a></span><span class="line">    <span class="mxinfo" id="T13:U56"><span class="var type1" id="S25T13U94">P_kk</span> = <span class="var type1" id="S12T13U95">P_km1km1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line">    <span class="comment">% Initialize the state vector</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line">    <span class="mxinfo" id="T17:U59"><span class="var type1" id="S13T17U98">x_km1km1</span> = <span class="mxinfo" id="T17:U61">zeros(<span class="mxinfo" id="T2:U62">10</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line">    <span class="mxinfo" id="T14:U63"><span class="mxinfo" id="T14:U64"><span class="var type1" id="S13T17U106">x_km1km1</span>(<span class="mxinfo" id="T15:U66"><span class="mxinfo" id="T2:U67">1</span>:<span class="mxinfo" id="T2:U68">4</span></span>,<span class="mxinfo" id="T2:U69">1</span>)</span> = <span class="mxinfo" id="T15:U70">[<span class="mxinfo" id="T2:U71">1</span> <span class="mxinfo" id="T2:U72">0</span> <span class="mxinfo" id="T2:U73">0</span> <span class="mxinfo" id="T2:U74">0</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line">    <span class="mxinfo" id="T1:U75"><span class="mxinfo" id="T1:U76"><span class="var type1" id="S13T17U120">x_km1km1</span>(<span class="mxinfo" id="T16:U78"><span class="mxinfo" id="T2:U79">5</span>:<span class="mxinfo" id="T2:U80">7</span></span>,<span class="mxinfo" id="T2:U81">1</span>)</span> = <span class="mxinfo" id="T1:U82"><span class="fcn" id="F71N6:B126">RotateVecSensor2Cont</span>(<span class="var type1" id="S7T1U127">w_gyro</span>, <span class="var type1" id="S21T14U128">q_s_c</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line">    <span class="mxinfo" id="T1:U85"><span class="mxinfo" id="T1:U86"><span class="var type1" id="S13T17U132">x_km1km1</span>(<span class="mxinfo" id="T16:U88"><span class="mxinfo" id="T2:U89">8</span>:<span class="mxinfo" id="T2:U90">10</span></span>,<span class="mxinfo" id="T2:U91">1</span>)</span> = <span class="mxinfo" id="T16:U92">[<span class="mxinfo" id="T2:U93">0</span> <span class="mxinfo" id="T2:U94">0</span> <span class="mxinfo" id="T2:U95">0</span>]</span></span>; <span class="comment">% Gyro Bias</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line">    <span class="mxinfo" id="T17:U96"><span class="var type1" id="S14T17U144">x_kk</span> = <span class="var type1" id="S13T17U145">x_km1km1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line">    <span class="comment">% Definitions</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line">    <span class="mxinfo" id="T2:U99"><span class="var type1" id="S28T2U148">L</span> = <span class="mxinfo" id="T2:U101">9</span></span>; <span class="comment">% number of states (3 quaternions &amp; 3 angular rates)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line">    <span class="mxinfo" id="T2:U102"><span class="var type1" id="S18T2U152">alpha</span> = <span class="mxinfo" id="T2:U104">sqrt(<span class="mxinfo" id="T2:U105">3</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line">    <span class="mxinfo" id="T2:U106"><span class="var type1" id="S19T2U158">K</span> = <span class="mxinfo" id="T2:U108">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line">    <span class="mxinfo" id="T2:U109"><span class="var type1" id="S17T2U162">Lambda</span> = <span class="mxinfo" id="T2:U111"><span class="mxinfo" id="T2:U112"><span class="mxinfo" id="T2:U113"><span class="var type1" id="S18T2U166">alpha</span>^2</span>*(<span class="mxinfo" id="T2:U115"><span class="var type1" id="S28T2U170">L</span>+<span class="var type1" id="S19T2U171">K</span></span>)</span> - <span class="var type1" id="S28T2U172">L</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line">    <span class="mxinfo" id="T19:U119"><span class="var type1" id="S15T19U175">R_k</span> = <span class="mxinfo" id="T19:U121"><span class="mxinfo" id="T19:U122">diag([0.05 0.05 0.05 0.012 0.012 0.012])</span>*<span class="mxinfo" id="T2:U123">1E-3</span></span></span>;  <span class="comment">% Measurement Noise Covariance</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line">    <span class="mxinfo" id="T13:U124"><span class="var type1" id="S16T13U190">Q_k</span> = <span class="mxinfo" id="T13:U126"><span class="mxinfo" id="T13:U127">diag([1 1 1 2 2 2 0.01 0.01 0.01])</span>*<span class="mxinfo" id="T2:U128">1E-6</span></span></span>;   <span class="comment">% Matrix for Process noise covariance</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line">    <span class="mxinfo" id="T2:U129"><span class="var type1" id="S20T2U208">Beta</span> = <span class="mxinfo" id="T2:U131">2</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line">    <span class="comment">% already initiated, go to regular operating mode</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line">    <span class="mxinfo" id="T2:U132"><span class="var type1" id="S28T2U213">L</span> = <span class="mxinfo" id="T2:U134">9</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line">    <span class="comment">% Allocate Returned Variable Sizes</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line">    <span class="mxinfo" id="T17:U135"><span class="var type1" id="S14T17U217">x_kk</span> = <span class="mxinfo" id="T17:U137">zeros(<span class="mxinfo" id="T2:U138">10</span>,1)</span></span>; <span class="comment">%#ok</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line">    <span class="mxinfo" id="T14:U139"><span class="var type1" id="S2T14U224">Attitude_sensor</span> = <span class="mxinfo" id="T14:U141">zeros(<span class="mxinfo" id="T2:U142">4</span>,1)</span></span>; <span class="comment">%#ok</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line">    <span class="mxinfo" id="T1:U143"><span class="var type1" id="S29T1U231">w_bias</span> = <span class="mxinfo" id="T1:U145">zeros(<span class="mxinfo" id="T2:U146">3</span>,1)</span></span>; <span class="comment">%#ok</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line">    <span class="comment">%% Sigma Points</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line">    <span class="comment">% Calculate the error sigma points</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line">    <span class="mxinfo" id="T13:U147"><span class="var type1" id="S30T13U238">DX_sigma</span> = <span class="mxinfo" id="T13:U149">chol( <span class="mxinfo" id="T13:U150">(<span class="mxinfo" id="T2:U151"><span class="var type1" id="S28T2U244">L</span>+<span class="var type1" id="S17T2U245">Lambda</span></span>)*<span class="var type1" id="S12T13U246">P_km1km1</span></span> )</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line">    <span class="mxinfo" id="T21:U155"><span class="var type1" id="S32T21U249">dX_km1km1</span> = <span class="mxinfo" id="T21:U157">[<span class="mxinfo" id="T36:U158">zeros(<span class="mxinfo" id="T2:U159"><span class="var type1" id="S28T2U254">L</span></span>,1)</span> <span class="mxinfo" id="T13:U161">-<span class="var type1" id="S30T13U257">DX_sigma</span></span> <span class="var type1" id="S30T13U258">DX_sigma</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line">    <span class="comment">% Calculate the full sigma points</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line">    <span class="mxinfo" id="T24:U164"><span class="var type1" id="S33T24U261">X_km1km1_temp</span> = <span class="mxinfo" id="T24:U166">zeros(<span class="mxinfo" id="T2:U167">4</span>,<span class="mxinfo" id="T2:U168">2*<span class="var type1" id="S28T2U268">L</span>+1</span>)</span></span>; <span class="comment">%#ok</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line">    <span class="mxinfo" id="T24:U170"><span class="var type1" id="S33T24U272">X_km1km1_temp</span> = <span class="mxinfo" id="T24:U172">[<span class="mxinfo" id="T23:U173">sqrt(<span class="mxinfo" id="T23:U174"><span class="mxinfo" id="T2:U175">1</span>-<span class="mxinfo" id="T23:U176">sum(<span class="mxinfo" id="T22:U177"><span class="mxinfo" id="T22:U178"><span class="var type1" id="S32T21U283">dX_km1km1</span>(<span class="mxinfo" id="T16:U180"><span class="mxinfo" id="T2:U181">1</span>:<span class="mxinfo" id="T2:U182">3</span></span>,:)</span>.^2</span>,1)</span></span>)</span>; <span class="mxinfo" id="T22:U183"><span class="var type1" id="S32T21U292">dX_km1km1</span>(<span class="mxinfo" id="T16:U185"><span class="mxinfo" id="T2:U186">1</span>:<span class="mxinfo" id="T2:U187">3</span></span>,:)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line">    <span class="mxinfo" id="T28:U188"><span class="var type1" id="S34T28U299">X_km1km1</span> = <span class="mxinfo" id="T28:U190">[<span class="mxinfo" id="T24:U191">quatmultiply(<span class="var type1" id="S33T24U304">X_km1km1_temp</span>, <span class="mxinfo" id="T14:U193"><span class="var type1" id="S13T17U306">x_km1km1</span>(<span class="mxinfo" id="T15:U195"><span class="mxinfo" id="T2:U196">1</span>:<span class="mxinfo" id="T2:U197">4</span></span>,<span class="mxinfo" id="T2:U198">1</span>)</span>)</span>;<span class="keyword">...</span></span></span><span class="comment"><span class="mxinfo" id="T28:U188"><span class="mxinfo" id="T28:U190">    </span></span><span class="comment"><span class="mxinfo" id="T28:U188"><span class="mxinfo" id="T28:U190">% Quaternion</span></span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line"><span class="mxinfo" id="T28:U188"><span class="mxinfo" id="T28:U190">        <span class="mxinfo" id="T22:U199"><span class="mxinfo" id="T22:U200"><span class="mxinfo" id="T1:U201"><span class="var type1" id="S13T17U315">x_km1km1</span>(<span class="mxinfo" id="T16:U203"><span class="mxinfo" id="T2:U204">5</span>:<span class="mxinfo" id="T2:U205">7</span></span>,<span class="mxinfo" id="T2:U206">1</span>)</span>*<span class="mxinfo" id="T23:U207">ones(1,2*<span class="var type1" id="S28T2U326">L</span>+1)</span></span> + <span class="mxinfo" id="T22:U209"><span class="var type1" id="S32T21U329">dX_km1km1</span>(<span class="mxinfo" id="T16:U211"><span class="mxinfo" id="T2:U212">4</span>:<span class="mxinfo" id="T2:U213">6</span></span>,:)</span></span>;<span class="keyword">...</span></span></span><span class="comment"><span class="mxinfo" id="T28:U188"><span class="mxinfo" id="T28:U190">                </span></span><span class="comment"><span class="mxinfo" id="T28:U188"><span class="mxinfo" id="T28:U190">% Angular Velocity</span></span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line"><span class="mxinfo" id="T28:U188"><span class="mxinfo" id="T28:U190">        <span class="mxinfo" id="T22:U214"><span class="mxinfo" id="T22:U215"><span class="mxinfo" id="T1:U216"><span class="var type1" id="S13T17U338">x_km1km1</span>(<span class="mxinfo" id="T16:U218"><span class="mxinfo" id="T2:U219">8</span>:<span class="mxinfo" id="T2:U220">10</span></span>,<span class="mxinfo" id="T2:U221">1</span>)</span>*<span class="mxinfo" id="T23:U222">ones(1,2*<span class="var type1" id="S28T2U349">L</span>+1)</span></span> + <span class="mxinfo" id="T22:U224"><span class="var type1" id="S32T21U352">dX_km1km1</span>(<span class="mxinfo" id="T16:U226"><span class="mxinfo" id="T2:U227">7</span>:<span class="mxinfo" id="T2:U228">9</span></span>,:)</span></span>]</span></span>;                 <span class="comment">% Gyro Bias</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line">    <span class="comment">% Propogate the sigma points with the nonlinear system model and the input</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line">    <span class="comment">% vector:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line">    <span class="mxinfo" id="T1:U229"><span class="var type1" id="S37T1U359">Torque_c</span> = <span class="mxinfo" id="T1:U231"><span class="fcn" id="F71N6:B361">RotateVecSensor2Cont</span>(<span class="var type1" id="S8T1U362">Torque_s</span>, <span class="var type1" id="S21T14U363">q_s_c</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line">    <span class="mxinfo" id="T28:U234"><span class="var type1" id="S38T28U366">X_kkm1</span> = <span class="mxinfo" id="T28:U236"><span class="fcn" id="F223N4:B368">RK4</span>(<span class="var type1" id="S34T28U369">X_km1km1</span>, <span class="var type1" id="S22T16U370">I_c</span>, <span class="var type1" id="S37T1U371">Torque_c</span>, <span class="var type1" id="S9T2U372">Ts</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line">    <span class="comment">% Calculate the priori state estimate</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line">    <span class="mxinfo" id="T2:U241"><span class="var type1" id="S40T2U375">W0_m</span> = <span class="mxinfo" id="T2:U243"><span class="var type1" id="S17T2U377">Lambda</span>/(<span class="mxinfo" id="T2:U245"><span class="var type1" id="S28T2U380">L</span> + <span class="var type1" id="S17T2U381">Lambda</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line">    <span class="mxinfo" id="T2:U248"><span class="var type1" id="S41T2U384">W0_c</span> = <span class="mxinfo" id="T2:U250"><span class="mxinfo" id="T2:U251"><span class="var type1" id="S17T2U387">Lambda</span>/(<span class="mxinfo" id="T2:U253"><span class="var type1" id="S28T2U390">L</span> + <span class="var type1" id="S17T2U391">Lambda</span></span>)</span> + (<span class="mxinfo" id="T2:U256"><span class="mxinfo" id="T2:U257"><span class="mxinfo" id="T2:U258">1</span>-<span class="mxinfo" id="T2:U259"><span class="var type1" id="S18T2U397">alpha</span>^2</span></span> + <span class="var type1" id="S20T2U399">Beta</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line">    <span class="mxinfo" id="T2:U262"><span class="var type1" id="S42T2U402">Wi_cm</span> = <span class="mxinfo" id="T2:U264"><span class="mxinfo" id="T2:U265">1</span>/(<span class="mxinfo" id="T2:U266"><span class="mxinfo" id="T2:U267">2</span>*(<span class="mxinfo" id="T2:U268"><span class="var type1" id="S28T2U410">L</span>+<span class="var type1" id="S17T2U411">Lambda</span></span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line">    <span class="mxinfo" id="T17:U271"><span class="var type1" id="S43T17U414">x_kkm1</span> = <span class="mxinfo" id="T17:U273">sum(<span class="mxinfo" id="T28:U274">[<span class="mxinfo" id="T17:U275"><span class="var type1" id="S40T2U420">W0_m</span>*<span class="mxinfo" id="T17:U277"><span class="var type1" id="S38T28U422">X_kkm1</span>(<span class="mxinfo" id="T45:U279"><span class="mxinfo" id="T2:U280">1</span>:<span class="mxinfo" id="T2:U281">10</span></span>,<span class="mxinfo" id="T2:U282">1</span>)</span></span>,<span class="mxinfo" id="T33:U283"><span class="var type1" id="S42T2U428">Wi_cm</span>*<span class="mxinfo" id="T33:U285"><span class="var type1" id="S38T28U430">X_kkm1</span>(<span class="mxinfo" id="T45:U287"><span class="mxinfo" id="T2:U288">1</span>:<span class="mxinfo" id="T2:U289">10</span></span>,<span class="mxinfo" id="T46:U290"><span class="mxinfo" id="T2:U291">2</span>:<span class="mxinfo" id="T2:U292">2*<span class="var type1" id="S28T2U439">L</span>+1</span></span>)</span></span>]</span>,2)</span></span>; <span class="comment">% sum along row</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line">    <span class="mxinfo" id="T14:U294"><span class="mxinfo" id="T14:U295"><span class="var type1" id="S43T17U445">x_kkm1</span>(<span class="mxinfo" id="T15:U297"><span class="mxinfo" id="T2:U298">1</span>:<span class="mxinfo" id="T2:U299">4</span></span>,<span class="mxinfo" id="T2:U300">1</span>)</span> = <span class="mxinfo" id="T14:U301"><span class="mxinfo" id="T14:U302"><span class="var type1" id="S43T17U452">x_kkm1</span>(<span class="mxinfo" id="T15:U304"><span class="mxinfo" id="T2:U305">1</span>:<span class="mxinfo" id="T2:U306">4</span></span>,<span class="mxinfo" id="T2:U307">1</span>)</span>./<span class="mxinfo" id="T2:U308">sqrt(<span class="mxinfo" id="T2:U309">sum(<span class="mxinfo" id="T14:U310"><span class="mxinfo" id="T14:U311"><span class="var type1" id="S43T17U463">x_kkm1</span>(<span class="mxinfo" id="T15:U313"><span class="mxinfo" id="T2:U314">1</span>:<span class="mxinfo" id="T2:U315">4</span></span>,<span class="mxinfo" id="T2:U316">1</span>)</span>.^2</span>)</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line">    <span class="comment">% Calculate full error state</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line">    <span class="mxinfo" id="T24:U317"><span class="var type1" id="S44T24U471">dX_kkm1_temp</span> = <span class="mxinfo" id="T24:U319">zeros(<span class="mxinfo" id="T2:U320">4</span>, <span class="mxinfo" id="T2:U321">2*<span class="var type1" id="S28T2U478">L</span>+1</span>)</span></span>; <span class="comment">%#ok</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line">    <span class="mxinfo" id="T24:U323"><span class="var type1" id="S44T24U482">dX_kkm1_temp</span> = <span class="mxinfo" id="T24:U325"><span class="fcn" id="F151N9:B484">quatmultiply</span>(<span class="mxinfo" id="T24:U326"><span class="var type1" id="S38T28U486">X_kkm1</span>(<span class="mxinfo" id="T15:U328"><span class="mxinfo" id="T2:U329">1</span>:<span class="mxinfo" id="T2:U330">4</span></span>,:)</span>, <span class="mxinfo" id="T14:U331"><span class="fcn" id="F69N8:B492">quatinv</span>(<span class="mxinfo" id="T14:U332"><span class="var type1" id="S43T17U494">x_kkm1</span>(<span class="mxinfo" id="T15:U334"><span class="mxinfo" id="T2:U335">1</span>:<span class="mxinfo" id="T2:U336">4</span></span>,<span class="mxinfo" id="T2:U337">1</span>)</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line">    <span class="mxinfo" id="T21:U338"><span class="var type1" id="S46T21U501">dX_kkm1</span> = <span class="mxinfo" id="T21:U340">[<span class="mxinfo" id="T22:U341"><span class="var type1" id="S44T24U505">dX_kkm1_temp</span>(<span class="mxinfo" id="T16:U343"><span class="mxinfo" id="T2:U344">2</span>:<span class="mxinfo" id="T2:U345">4</span></span>,<span class="mxinfo" id="T23:U346"><span class="mxinfo" id="T2:U347">1</span>:<span class="mxinfo" id="T2:U348">2*<span class="var type1" id="S28T2U514">L</span>+1</span></span>)</span>;<span class="keyword">...</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line"><span class="mxinfo" id="T21:U338"><span class="mxinfo" id="T21:U340">        <span class="mxinfo" id="T35:U350"><span class="mxinfo" id="T35:U351"><span class="var type1" id="S38T28U519">X_kkm1</span>(<span class="mxinfo" id="T18:U353"><span class="mxinfo" id="T2:U354">5</span>:<span class="mxinfo" id="T2:U355">10</span></span>,:)</span> - <span class="mxinfo" id="T35:U356"><span class="mxinfo" id="T34:U357"><span class="var type1" id="S43T17U526">x_kkm1</span>(<span class="mxinfo" id="T18:U359"><span class="mxinfo" id="T2:U360">5</span>:<span class="mxinfo" id="T2:U361">10</span></span>,<span class="mxinfo" id="T2:U362">1</span>)</span>*<span class="mxinfo" id="T23:U363">ones(1,2*<span class="var type1" id="S28T2U537">L</span>+1)</span></span></span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line">    <span class="comment">% Calculate mean error state</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line">    <span class="mxinfo" id="T36:U365"><span class="var type1" id="S47T36U541">dx_kkm1</span> = <span class="mxinfo" id="T36:U367">sum(<span class="mxinfo" id="T21:U368">[<span class="mxinfo" id="T36:U369"><span class="var type1" id="S40T2U547">W0_m</span>*<span class="mxinfo" id="T36:U371"><span class="var type1" id="S46T21U549">dX_kkm1</span>(:,<span class="mxinfo" id="T2:U373">1</span>)</span></span>,<span class="mxinfo" id="T37:U374"><span class="var type1" id="S42T2U553">Wi_cm</span>*<span class="mxinfo" id="T37:U376"><span class="var type1" id="S46T21U555">dX_kkm1</span>(:,<span class="mxinfo" id="T46:U378"><span class="mxinfo" id="T2:U379">2</span>:<span class="mxinfo" id="T2:U380">2*<span class="var type1" id="S28T2U562">L</span>+1</span></span>)</span></span>]</span>,2)</span></span>; <span class="comment">% sum along row</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line">    <span class="comment">% Calculate the priori error covariance matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line">    <span class="mxinfo" id="T13:U382"><span class="var type1" id="S48T13U567">P_kkm1</span> = <span class="mxinfo" id="T13:U384">zeros(<span class="mxinfo" id="T2:U385"><span class="var type1" id="S28T2U570">L</span></span>,<span class="mxinfo" id="T2:U387"><span class="var type1" id="S28T2U571">L</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S49T2U574">i</span> = <span class="mxinfo" id="T2:U390">1</span>:2*<span class="var type1" id="S28T2U580">L</span>+1</span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo" id="T5:U392"><span class="var type1" id="S49T2U585">i</span> == <span class="mxinfo" id="T2:U394">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line">            <span class="mxinfo" id="T13:U395"><span class="var type1" id="S48T13U589">P_kkm1</span> = <span class="mxinfo" id="T13:U397"><span class="mxinfo" id="T13:U398"><span class="mxinfo" id="T36:U399"><span class="var type1" id="S41T2U593">W0_c</span>*(<span class="mxinfo" id="T36:U401"><span class="mxinfo" id="T36:U402"><span class="var type1" id="S46T21U597">dX_kkm1</span>(:,<span class="var type1" id="S49T2U599">i</span>)</span> - <span class="var type1" id="S47T36U600">dx_kkm1</span></span>)</span>*<span class="keyword">...</span></span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line"><span class="mxinfo" id="T13:U395"><span class="mxinfo" id="T13:U397"><span class="mxinfo" id="T13:U398">                <span class="mxinfo" id="T12:U406">(<span class="mxinfo" id="T36:U407"><span class="mxinfo" id="T36:U408"><span class="var type1" id="S46T21U605">dX_kkm1</span>(:,<span class="var type1" id="S49T2U607">i</span>)</span> - <span class="var type1" id="S47T36U608">dx_kkm1</span></span>)'</span></span> + <span class="var type1" id="S48T13U609">P_kkm1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line">        <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line">            <span class="mxinfo" id="T13:U413"><span class="var type1" id="S48T13U613">P_kkm1</span> = <span class="mxinfo" id="T13:U415"><span class="mxinfo" id="T13:U416"><span class="mxinfo" id="T36:U417"><span class="var type1" id="S42T2U617">Wi_cm</span>*(<span class="mxinfo" id="T36:U419"><span class="mxinfo" id="T36:U420"><span class="var type1" id="S46T21U621">dX_kkm1</span>(:,<span class="var type1" id="S49T2U623">i</span>)</span> - <span class="var type1" id="S47T36U624">dx_kkm1</span></span>)</span>*<span class="keyword">...</span></span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,96" id="srcline96"> 96</a></span><span class="line"><span class="mxinfo" id="T13:U413"><span class="mxinfo" id="T13:U415"><span class="mxinfo" id="T13:U416">                <span class="mxinfo" id="T12:U424">(<span class="mxinfo" id="T36:U425"><span class="mxinfo" id="T36:U426"><span class="var type1" id="S46T21U629">dX_kkm1</span>(:,<span class="var type1" id="S49T2U631">i</span>)</span> - <span class="var type1" id="S47T36U632">dx_kkm1</span></span>)'</span></span> + <span class="var type1" id="S48T13U633">P_kkm1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,97" id="srcline97"> 97</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,98" id="srcline98"> 98</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,99" id="srcline99"> 99</a></span><span class="line">    <span class="mxinfo" id="T13:U431"><span class="var type1" id="S48T13U636">P_kkm1</span> = <span class="mxinfo" id="T13:U433"><span class="var type1" id="S48T13U638">P_kkm1</span> + <span class="var type1" id="S16T13U639">Q_k</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,100" id="srcline100">100</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,101" id="srcline101">101</a></span><span class="line">    <span class="comment">% Propogate the sigma points through the sensor model in order to obtain</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,102" id="srcline102">102</a></span><span class="line">    <span class="comment">% the transformed sigma points. Predicted measurements must be in the</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,103" id="srcline103">103</a></span><span class="line">    <span class="comment">% satelite reference frame.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,104" id="srcline104">104</a></span><span class="line">    <span class="mxinfo" id="T35:U436"><span class="var type1" id="S50T35U642">Z_kkm1_control</span> = <span class="mxinfo" id="T35:U438">zeros(<span class="mxinfo" id="T2:U439">6</span>, <span class="mxinfo" id="T2:U440">2*<span class="var type1" id="S28T2U649">L</span>+1</span>)</span></span>; <span class="comment">%#ok</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,105" id="srcline105">105</a></span><span class="line">    <span class="mxinfo" id="T34:U442"><span class="var type1" id="S51T34U653">z_kkm1_control</span> = <span class="mxinfo" id="T34:U444">zeros(<span class="mxinfo" id="T2:U445">6</span>,1)</span></span>; <span class="comment">%#ok</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,106" id="srcline106">106</a></span><span class="line">    <span class="mxinfo" id="T35:U446"><span class="var type1" id="S50T35U660">Z_kkm1_control</span> = <span class="mxinfo" id="T35:U448"><span class="fcn" id="F259N7:B662">SensorModel</span>(<span class="var type1" id="S38T28U663">X_kkm1</span>, <span class="var type1" id="S5T1U664">B_ref</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,107" id="srcline107">107</a></span><span class="line">    <span class="mxinfo" id="T34:U451"><span class="var type1" id="S51T34U667">z_kkm1_control</span> = <span class="mxinfo" id="T34:U453">sum(<span class="mxinfo" id="T35:U454">[<span class="mxinfo" id="T34:U455"><span class="var type1" id="S40T2U673">W0_m</span>*<span class="mxinfo" id="T34:U457"><span class="var type1" id="S50T35U675">Z_kkm1_control</span>(:,<span class="mxinfo" id="T2:U459">1</span>)</span></span>,<span class="mxinfo" id="T38:U460"><span class="var type1" id="S42T2U679">Wi_cm</span>*<span class="mxinfo" id="T38:U462"><span class="var type1" id="S50T35U681">Z_kkm1_control</span>(:,<span class="mxinfo" id="T46:U464"><span class="mxinfo" id="T2:U465">2</span>:<span class="mxinfo" id="T2:U466">end</span></span>)</span></span>]</span>,2)</span></span>; <span class="comment">% sum along row</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,108" id="srcline108">108</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,109" id="srcline109">109</a></span><span class="line">    <span class="comment">% Calculate the posteriori state estimate using the measurement vector</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,110" id="srcline110">110</a></span><span class="line">    <span class="comment">% containing measurements obtained at k:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,111" id="srcline111">111</a></span><span class="line">    <span class="mxinfo" id="T19:U467"><span class="var type1" id="S54T19U690">P_zkzk</span> = <span class="mxinfo" id="T19:U469">zeros(<span class="mxinfo" id="T2:U470">6</span>,<span class="mxinfo" id="T2:U471">6</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,112" id="srcline112">112</a></span><span class="line">    <span class="mxinfo" id="T39:U472"><span class="var type1" id="S55T39U697">P_xkzk</span> = <span class="mxinfo" id="T39:U474">zeros(<span class="mxinfo" id="T2:U475">9</span>,<span class="mxinfo" id="T2:U476">6</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,113" id="srcline113">113</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S49T2U704">i</span> = <span class="mxinfo" id="T2:U478">1</span>:2*<span class="var type1" id="S28T2U710">L</span>+1</span></span>
<span class="srcline"><span class="lineno"><a href="1,114" id="srcline114">114</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo" id="T5:U480"><span class="var type1" id="S49T2U715">i</span> == <span class="mxinfo" id="T2:U482">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,115" id="srcline115">115</a></span><span class="line">            <span class="mxinfo" id="T19:U483"><span class="var type1" id="S54T19U719">P_zkzk</span> = <span class="mxinfo" id="T19:U485"><span class="mxinfo" id="T19:U486"><span class="mxinfo" id="T34:U487"><span class="var type1" id="S41T2U723">W0_c</span>*(<span class="mxinfo" id="T34:U489"><span class="mxinfo" id="T34:U490"><span class="var type1" id="S50T35U727">Z_kkm1_control</span>(:,<span class="var type1" id="S49T2U729">i</span>)</span> - <span class="var type1" id="S51T34U730">z_kkm1_control</span></span>)</span>*<span class="keyword">...</span></span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,116" id="srcline116">116</a></span><span class="line"><span class="mxinfo" id="T19:U483"><span class="mxinfo" id="T19:U485"><span class="mxinfo" id="T19:U486">                <span class="mxinfo" id="T18:U494">(<span class="mxinfo" id="T34:U495"><span class="mxinfo" id="T34:U496"><span class="var type1" id="S50T35U735">Z_kkm1_control</span>(:,<span class="var type1" id="S49T2U737">i</span>)</span> - <span class="var type1" id="S51T34U738">z_kkm1_control</span></span>)'</span></span> + <span class="var type1" id="S54T19U739">P_zkzk</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,117" id="srcline117">117</a></span><span class="line">            <span class="mxinfo" id="T39:U501"><span class="var type1" id="S55T39U742">P_xkzk</span> = <span class="mxinfo" id="T39:U503"><span class="mxinfo" id="T39:U504"><span class="mxinfo" id="T36:U505"><span class="var type1" id="S41T2U746">W0_c</span>*(<span class="mxinfo" id="T36:U507"><span class="mxinfo" id="T36:U508"><span class="var type1" id="S46T21U750">dX_kkm1</span>(:,<span class="var type1" id="S49T2U752">i</span>)</span> - <span class="var type1" id="S47T36U753">dx_kkm1</span></span>)</span>*<span class="keyword">...</span></span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,118" id="srcline118">118</a></span><span class="line"><span class="mxinfo" id="T39:U501"><span class="mxinfo" id="T39:U503"><span class="mxinfo" id="T39:U504">                <span class="mxinfo" id="T18:U512">(<span class="mxinfo" id="T34:U513"><span class="mxinfo" id="T34:U514"><span class="var type1" id="S50T35U758">Z_kkm1_control</span>(:,<span class="var type1" id="S49T2U760">i</span>)</span> - <span class="var type1" id="S51T34U761">z_kkm1_control</span></span>)'</span></span> + <span class="var type1" id="S55T39U762">P_xkzk</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,119" id="srcline119">119</a></span><span class="line">        <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,120" id="srcline120">120</a></span><span class="line">            <span class="mxinfo" id="T19:U519"><span class="var type1" id="S54T19U766">P_zkzk</span> = <span class="mxinfo" id="T19:U521"><span class="mxinfo" id="T19:U522"><span class="mxinfo" id="T34:U523"><span class="var type1" id="S42T2U770">Wi_cm</span>*(<span class="mxinfo" id="T34:U525"><span class="mxinfo" id="T34:U526"><span class="var type1" id="S50T35U774">Z_kkm1_control</span>(:,<span class="var type1" id="S49T2U776">i</span>)</span> - <span class="var type1" id="S51T34U777">z_kkm1_control</span></span>)</span>*<span class="keyword">...</span></span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,121" id="srcline121">121</a></span><span class="line"><span class="mxinfo" id="T19:U519"><span class="mxinfo" id="T19:U521"><span class="mxinfo" id="T19:U522">                <span class="mxinfo" id="T18:U530">(<span class="mxinfo" id="T34:U531"><span class="mxinfo" id="T34:U532"><span class="var type1" id="S50T35U782">Z_kkm1_control</span>(:,<span class="var type1" id="S49T2U784">i</span>)</span> - <span class="var type1" id="S51T34U785">z_kkm1_control</span></span>)'</span></span> + <span class="var type1" id="S54T19U786">P_zkzk</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,122" id="srcline122">122</a></span><span class="line">            <span class="mxinfo" id="T39:U537"><span class="var type1" id="S55T39U789">P_xkzk</span> = <span class="mxinfo" id="T39:U539"><span class="mxinfo" id="T39:U540"><span class="mxinfo" id="T36:U541"><span class="var type1" id="S42T2U793">Wi_cm</span>*(<span class="mxinfo" id="T36:U543"><span class="mxinfo" id="T36:U544"><span class="var type1" id="S46T21U797">dX_kkm1</span>(:,<span class="var type1" id="S49T2U799">i</span>)</span> - <span class="var type1" id="S47T36U800">dx_kkm1</span></span>)</span>*<span class="keyword">...</span></span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,123" id="srcline123">123</a></span><span class="line"><span class="mxinfo" id="T39:U537"><span class="mxinfo" id="T39:U539"><span class="mxinfo" id="T39:U540">                <span class="mxinfo" id="T18:U548">(<span class="mxinfo" id="T34:U549"><span class="mxinfo" id="T34:U550"><span class="var type1" id="S50T35U805">Z_kkm1_control</span>(:,<span class="var type1" id="S49T2U807">i</span>)</span> - <span class="var type1" id="S51T34U808">z_kkm1_control</span></span>)'</span></span> + <span class="var type1" id="S55T39U809">P_xkzk</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,124" id="srcline124">124</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,125" id="srcline125">125</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,126" id="srcline126">126</a></span><span class="line">    <span class="mxinfo" id="T19:U555"><span class="var type1" id="S54T19U812">P_zkzk</span> = <span class="mxinfo" id="T19:U557"><span class="var type1" id="S54T19U814">P_zkzk</span> + <span class="var type1" id="S15T19U815">R_k</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,127" id="srcline127">127</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,128" id="srcline128">128</a></span><span class="line">    <span class="comment">% Calculate the Kalman gain</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,129" id="srcline129">129</a></span><span class="line">    <span class="mxinfo" id="T39:U560"><span class="var type1" id="S56T39U818">K_k</span> = <span class="mxinfo" id="T39:U562"><span class="var type1" id="S55T39U820">P_xkzk</span>/<span class="var type1" id="S54T19U821">P_zkzk</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,130" id="srcline130">130</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,131" id="srcline131">131</a></span><span class="line">    <span class="comment">% Normalize predicted maganetic field vector</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,132" id="srcline132">132</a></span><span class="line">    <span class="mxinfo" id="T16:U565"><span class="mxinfo" id="T16:U566"><span class="var type1" id="S51T34U825">z_kkm1_control</span>(<span class="mxinfo" id="T16:U568"><span class="mxinfo" id="T2:U569">1</span>:<span class="mxinfo" id="T2:U570">3</span></span>)</span> = <span class="mxinfo" id="T1:U571"><span class="mxinfo" id="T1:U572"><span class="var type1" id="S51T34U831">z_kkm1_control</span>(<span class="mxinfo" id="T16:U574"><span class="mxinfo" id="T2:U575">1</span>:<span class="mxinfo" id="T2:U576">3</span></span>)</span>./<span class="mxinfo" id="T2:U577">sqrt(<span class="mxinfo" id="T2:U578">sum(<span class="mxinfo" id="T1:U579"><span class="mxinfo" id="T1:U580"><span class="var type1" id="S51T34U841">z_kkm1_control</span>(<span class="mxinfo" id="T16:U582"><span class="mxinfo" id="T2:U583">1</span>:<span class="mxinfo" id="T2:U584">3</span></span>)</span>.^2</span>)</span>)</span></span></span>; <span class="comment">% normalize Z vector</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,133" id="srcline133">133</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,134" id="srcline134">134</a></span><span class="line">    <span class="comment">% Rotate measurements from sensor to control reference frame.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,135" id="srcline135">135</a></span><span class="line">    <span class="mxinfo" id="T1:U585"><span class="var type1" id="S57T1U848">B_control</span> = <span class="mxinfo" id="T1:U587"><span class="fcn" id="F71N6:B850">RotateVecSensor2Cont</span>(<span class="var type1" id="S6T1U851">B_sat</span>, <span class="var type1" id="S21T14U852">q_s_c</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,136" id="srcline136">136</a></span><span class="line">    <span class="mxinfo" id="T1:U590"><span class="var type1" id="S58T1U855">w_control</span> = <span class="mxinfo" id="T1:U592"><span class="fcn" id="F71N6:B857">RotateVecSensor2Cont</span>(<span class="var type1" id="S7T1U858">w_gyro</span>, <span class="var type1" id="S21T14U859">q_s_c</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,137" id="srcline137">137</a></span><span class="line">    <span class="mxinfo" id="T36:U595"><span class="var type1" id="S59T36U862">dx_kk</span> = <span class="mxinfo" id="T36:U597"><span class="var type1" id="S56T39U864">K_k</span>*(<span class="mxinfo" id="T34:U599"><span class="mxinfo" id="T34:U600">[<span class="var type1" id="S57T1U869">B_control</span>; <span class="var type1" id="S58T1U871">w_control</span>]</span> - <span class="var type1" id="S51T34U872">z_kkm1_control</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,138" id="srcline138">138</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,139" id="srcline139">139</a></span><span class="line">    <span class="comment">% Calculate the full state</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,140" id="srcline140">140</a></span><span class="line">    <span class="mxinfo" id="T17:U604"><span class="var type1" id="S14T17U875">x_kk</span> = <span class="mxinfo" id="T17:U606">[<span class="mxinfo" id="T14:U607">quatmultiply(<span class="mxinfo" id="T14:U608">[<span class="mxinfo" id="T2:U609">sqrt(<span class="mxinfo" id="T2:U610"><span class="mxinfo" id="T2:U611">1</span>-<span class="mxinfo" id="T2:U612">sum(<span class="mxinfo" id="T1:U613"><span class="mxinfo" id="T1:U614"><span class="var type1" id="S59T36U890">dx_kk</span>(<span class="mxinfo" id="T16:U616"><span class="mxinfo" id="T2:U617">1</span>:<span class="mxinfo" id="T2:U618">3</span></span>)</span>.^2</span>)</span></span>)</span>; <span class="mxinfo" id="T1:U619"><span class="var type1" id="S59T36U897">dx_kk</span>(<span class="mxinfo" id="T16:U621"><span class="mxinfo" id="T2:U622">1</span>:<span class="mxinfo" id="T2:U623">3</span></span>)</span>]</span>, <span class="mxinfo" id="T14:U624"><span class="var type1" id="S43T17U902">x_kkm1</span>(<span class="mxinfo" id="T15:U626"><span class="mxinfo" id="T2:U627">1</span>:<span class="mxinfo" id="T2:U628">4</span></span>,<span class="mxinfo" id="T2:U629">1</span>)</span>)</span>;<span class="keyword">...</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,141" id="srcline141">141</a></span><span class="line"><span class="mxinfo" id="T17:U604"><span class="mxinfo" id="T17:U606">        <span class="mxinfo" id="T1:U630"><span class="mxinfo" id="T1:U631"><span class="var type1" id="S43T17U910">x_kkm1</span>(<span class="mxinfo" id="T16:U633"><span class="mxinfo" id="T2:U634">5</span>:<span class="mxinfo" id="T2:U635">7</span></span>,<span class="mxinfo" id="T2:U636">1</span>)</span> + <span class="mxinfo" id="T1:U637"><span class="var type1" id="S59T36U916">dx_kk</span>(<span class="mxinfo" id="T16:U639"><span class="mxinfo" id="T2:U640">4</span>:<span class="mxinfo" id="T2:U641">6</span></span>,<span class="mxinfo" id="T2:U642">1</span>)</span></span>;<span class="keyword">...</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,142" id="srcline142">142</a></span><span class="line"><span class="mxinfo" id="T17:U604"><span class="mxinfo" id="T17:U606">        <span class="mxinfo" id="T1:U643"><span class="mxinfo" id="T1:U644"><span class="var type1" id="S43T17U924">x_kkm1</span>(<span class="mxinfo" id="T16:U646"><span class="mxinfo" id="T2:U647">8</span>:<span class="mxinfo" id="T2:U648">10</span></span>,<span class="mxinfo" id="T2:U649">1</span>)</span> + <span class="mxinfo" id="T1:U650"><span class="var type1" id="S59T36U930">dx_kk</span>(<span class="mxinfo" id="T16:U652"><span class="mxinfo" id="T2:U653">7</span>:<span class="mxinfo" id="T2:U654">9</span></span>,<span class="mxinfo" id="T2:U655">1</span>)</span></span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,143" id="srcline143">143</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,144" id="srcline144">144</a></span><span class="line">    <span class="comment">% Calculate the a posteriori error covariance</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,145" id="srcline145">145</a></span><span class="line">    <span class="mxinfo" id="T13:U656"><span class="var type1" id="S25T13U937">P_kk</span> = <span class="mxinfo" id="T13:U658"><span class="var type1" id="S48T13U939">P_kkm1</span> - <span class="mxinfo" id="T13:U660"><span class="mxinfo" id="T39:U661"><span class="var type1" id="S56T39U942">K_k</span>*<span class="var type1" id="S54T19U943">P_zkzk</span></span>*<span class="mxinfo" id="T40:U664"><span class="var type1" id="S56T39U945">K_k</span>'</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,146" id="srcline146">146</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,147" id="srcline147">147</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,148" id="srcline148">148</a></span><span class="line"><span class="comment">%% Store, Rotate, and Deliver</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,149" id="srcline149">149</a></span><span class="line"><span class="comment">% Store states for next call</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,150" id="srcline150">150</a></span><span class="line"><span class="mxinfo" id="T13:U666"><span class="var type1" id="S12T13U948">P_km1km1</span> = <span class="var type1" id="S25T13U949">P_kk</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,151" id="srcline151">151</a></span><span class="line"><span class="mxinfo" id="T17:U669"><span class="var type1" id="S13T17U952">x_km1km1</span> = <span class="var type1" id="S14T17U953">x_kk</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,152" id="srcline152">152</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,153" id="srcline153">153</a></span><span class="line"><span class="comment">% Convert states from satellite controller frame to the reference frame</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,154" id="srcline154">154</a></span><span class="line"><span class="mxinfo" id="T14:U672"><span class="var type1" id="S2T14U956">Attitude_sensor</span> = <span class="mxinfo" id="T14:U674"><span class="fcn" id="F70N9:B958">quatmultiply</span>(<span class="mxinfo" id="T14:U675"><span class="var type1" id="S14T17U960">x_kk</span>(<span class="mxinfo" id="T15:U677"><span class="mxinfo" id="T2:U678">1</span>:<span class="mxinfo" id="T2:U679">4</span></span>,<span class="mxinfo" id="T2:U680">1</span>)</span>, <span class="mxinfo" id="T14:U681"><span class="fcn" id="F69N8:B966">quatinv</span>(<span class="var type1" id="S21T14U967">q_s_c</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,155" id="srcline155">155</a></span><span class="line"><span class="mxinfo" id="T1:U683"><span class="var type1" id="S3T1U970">w_sensor</span> = <span class="mxinfo" id="T1:U685"><span class="fcn" id="F388N5:B972">RotateVecCont2Sensor</span>(<span class="mxinfo" id="T1:U686"><span class="var type1" id="S14T17U974">x_kk</span>(<span class="mxinfo" id="T16:U688"><span class="mxinfo" id="T2:U689">5</span>:<span class="mxinfo" id="T2:U690">7</span></span>,<span class="mxinfo" id="T2:U691">1</span>)</span>, <span class="var type1" id="S21T14U979">q_s_c</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,156" id="srcline156">156</a></span><span class="line"><span class="mxinfo" id="T1:U693"><span class="var type1" id="S4T1U982">w_bias_sensor</span> = <span class="mxinfo" id="T1:U695"><span class="fcn" id="F388N5:B984">RotateVecCont2Sensor</span>(<span class="mxinfo" id="T1:U696"><span class="var type1" id="S14T17U986">x_kk</span>(<span class="mxinfo" id="T16:U698"><span class="mxinfo" id="T2:U699">8</span>:<span class="mxinfo" id="T2:U700">10</span></span>,<span class="mxinfo" id="T2:U701">1</span>)</span>, <span class="var type1" id="S21T14U991">q_s_c</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,157" id="srcline157">157</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,158" id="srcline158">158</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,159" id="srcline159">159</a></span><span class="line"></span></span>
</pre>
